<div class="input-field animated fadeinright">
    <label for="foto" class="label-required">Adjuntar Fotos</label>
    <div id="dZUpload" name="dZUpload" class="dropzone">
        <div id="sms_drp" class="dz-message">
            Arrastre los archivos aqu√≠.
        </div>
    </div>
</div>
<script type="text/javascript">
$("#dZUpload").dropzone({
    url: `${url}?q=cargar_editar`,
    addRemoveLinks: true, 
    autoProcessQueue: false, 
    acceptedFiles: ".jpg, .JPEG, .JPG, .png",
    uploadMultiple: true,
    parallelUploads: 10,
    maxFiles: 5,
    timeout: 180000,
    maxFilesize: 100,
    init: function() {
        var mensaje = false; // Para que no se repita el mensjase si es que hay mas de una imagen
        myDropzone = this;
        this.on('sending', function(file, xhr, formData) {
            mensaje = false;
            NProgress.start();
            $('#eliminar, #guardar').prop('disabled', true);

            var data = $('#formulario').serializeArray();
            formData.append('proveedores', JSON.stringify($('#tabla_proveedores').bootstrapTable('getData')));
            formData.append('principios', JSON.stringify($('#tabla_principios').bootstrapTable('getData')));
            formData.append('stock_niveles', JSON.stringify($('#tabla_cuatro').bootstrapTable('getData')));
            formData.append('clasificacion', JSON.stringify($('#productos_clasificaciones').bootstrapTable('getData')));

            $.each(data, function(key, el) {
                formData.append(
                    el.name,
                    el.value
                );
            });
        });
        this.on("success", function(file, xhr) {
            if (mensaje === false) {
                mensaje = true;
                var data = JSON.parse(xhr);
                NProgress.done();
                $('#eliminar, #guardar').prop('disabled', false);

                if (data.status == 'ok') {
                    $('#modal').modal('hide');
                    $('#tabla').bootstrapTable('refresh');
                    alertDismissJS(data.mensaje, data.status);
                } else if (data.status == 'error' && data.error == 'principios') {
                    $('#principios-tab').tab('show');
                    alertDismissJS(data.mensaje, data.status, () => $('#principio').focus());
                } else if (data.status == 'error' && data.error == 'proveedores') {
                    $('#proveedores-tab').tab('show');
                    alertDismissJS(data.mensaje, data.status, () => $('#proveedor').focus());
                } else if (data.status == 'error' && data.error == 'stock_niveles') {
                    $('#nav-cuatro').tab('show');
                    alertDismissJS(data.mensaje, data.status, () => $('#proveedor').focus());
                } else {
                    alertDismissJS(data.mensaje, data.status);
                }
            }
        });
        this.on("removedfile", function(file, xhr) {
            $.ajax({
                dataType: 'json',
                type: 'POST',
                url: url,
                cache: false,
                data: { q: 'borrar_fotos', foto: file.name },	
                beforeSend: function() {
                    // NProgress.start();
                },
                success: function (data, status, xhr) {
                    // NProgress.done();
                    // alertDismissJS(data.mensaje, data.status);
                },
                error: function (jqXhr) {
                    alertDismissJS($(jqXhr.responseText).text().trim(), "error");
                }
            });
        });
    }
});
</script>
